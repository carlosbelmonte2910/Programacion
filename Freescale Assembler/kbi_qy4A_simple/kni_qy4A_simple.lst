
kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 
                                                                              1



                        1  ;***************************************************
                                                    ***************************
                        2  ;                    CURSO HC908QY 
                        3  ;***************************************************
                                                    ***************************
                        4  ;+++++++++++++++++++++++++++++++++++++++++++++++++++
                                                  +++++++++++++++++++++++++++++
                        5  ;utilizo el timer y kbi, los dos por interrupciones 
                                                   mientras que en el programa 
                        6  ;principal se este desarrollando otro trabajo 
                                          independientes de las interrupciones,
                        7  ;en el kbi cuando se presiones el pul_kbi se 
                                           habilitara la interrupcion que sera 
                        8  ;prender el led_3 del ptb, mientras que el timer 
                                               overflow prendera y apagara cada
                        9  ; 1 seg el led_7 del ptb.
                       10  ;+++++++++++++++++++++++++++++++++++++++++++++++++++
                                                  +++++++++++++++++++++++++++++
                       11  ;***************************************************
                                                    ***************************
                       12  ;            DEFINICION DEL MAPA DE MEMORIA DEL 
                                                                   MC68HC908QT1
                       13  ;***************************************************
                                                    ***************************
 0000                  14  RAM_INI              EQU     $0080           
                                                 ;Direccion de Inicio de la RAM
 0000                  15  RAM_FIN              EQU     $0100           ;(+1) 
                                                                128 Bytes.p/QY4
 0000                  16  FLASH_INI    EQU     $F800           ;Dir.de Inicio 
                                                         de FLASH ($F800 p/QY1)
 0000                  17  FLASH_END    EQU     $FDFF           ;4 KBytes 
                                                          p/QY4 - 1 KByte p/QY1
 0000                  18  VECTORES     EQU     $FFDE           ;Vectores de 
                                                                   Interrupcion
                       19  
                       20  ;***************************************************
                                                    ***************************
                       21  ;                    ARCHIVOS DE DEFINICION 
                                                                      INCLUIDOS
                       22  ;***************************************************
                                                    ***************************
 0000                  23  $base                10t                     ;Base 
                                                            decimal por Default
 0000                  24  $Include        'QTQY_registers.inc' ;Definiciones 
                                                            de Registros p/QTxx
                       25  ;***************************************************
                                                    ***************************
                       26  ;                    QTQY_REGISTERS.INC - ARCHIVO 
                                                                        INCLUDE
                       27  ; Contiene las Definiciones de los Registros del 
                                                       MC68HC908QTA/QYA/8/4/2/1
                       28  ;
                       29  ;                    SyHDe - Soft y Hard Desarrollos
                       30  ;***************************************************
                                                    ***************************
                       31  
                       32  ;***************************************************


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 2



                                                    ***************************
                       33  ;---------------REGISTROS DE PUERTOS ENT/SAL--------
                                                    ---------------------------
                       34  ;---------------PUERTO A----------------------------
                                                    ---------------------------
 0000                  35  PTA  EQU     $0000   ; Port A Data register
 0000                  36  PORTA        EQU     $0000   ; "
 0000                  37  DDRA EQU     $0004   ; Port A Data Direction 
                                                                       Register
 0000                  38  PTAPUE  EQU  $000B   ; Port A Pull Ups Enable
                       39  
                       40  ;---------------PUERTO B----------------------------
                                                    ---------------------------
 0000                  41  PTB  EQU     $0001   ; Port B Data register
 0000                  42  PORTB        EQU     $0001   ; "
 0000                  43  DDRB EQU     $0005   ; Port B Data Direction 
                                                                       Register
 0000                  44  PTBPUE  EQU  $000C   ; Port B Pull Ups Enable
                       45  
                       46  ;***************************************************
                                                    ***************************
                       47  ;---------------REGISTROS DEL MODULO KEYBOARD-------
                                                    ---------------------------
 0000                  48  KBSCR        EQU     $001A   ; Keyboard Status & 
                                                               Control register
 0000                  49  keyf equ     3       ;
 0000                  50  ackk equ     2       ;
 0000                  51  imaskk       equ     1       ;
 0000                  52  modek        equ     0       ;
                       53  
 0000                  54  KBIER        EQU     $001B   ; Keyboard interrupt 
                                                                enable register
                       55  
                       56  ;***************************************************
                                                    ***************************
                       57  ;---------------REGISTROS DE INTERRUPCION EXTERNA 
                                                  1----------------------------
 0000                  58  INTSCR       EQU     $001D   ; IRQ Status & Control 
                                                                       Register
 0000                  59  irqf equ     3       ;
 0000                  60  ack  equ     2       ;
 0000                  61  imask        equ     1       ;
 0000                  62  mode equ     0       ;
                       63  
                       64  ;***************************************************
                                                    ***************************
                       65  ;---------------REGISTROS DE CONFIGURACION----------
                                                    ---------------------------
 0000                  66  CONFIG1      EQU     $001F   ; Configuration 
                                                                     Register 1
                       67  
 0000                  68  CONFIG2      EQU     $001E   ; Configuration 
                                                                     Register 2
                       69  
                       70  ;***************************************************
                                                    ***************************
                       71  ;---------------REGISTROS DEL TIMER ----------------
                                                    ---------------------------


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 3



 0000                  72  TSC  EQU     $0020   ; Timer Status & Control 
                                                                       Register
 0000                  73  tof  equ     7       ;
 0000                  74  toie equ     6       ;
 0000                  75  tstop        equ     5       ;
 0000                  76  trst equ     4       ;
                       77  
 0000                  78  TCNTH        EQU     $0021   ; Timer Counter 
                                                                  Register High
 0000                  79  TCNTL        EQU     $0022   ; Timer Counter 
                                                                   Register Low
 0000                  80  TMODH        EQU     $0023   ; Timer Counter Modulo 
                                                                  Register High
 0000                  81  TMODL        EQU     $0024   ; Timer Counter Modulo 
                                                                   Register Low
                       82  
 0000                  83  TSC0 EQU     $0025   ; Timer Channel 0 Status & 
                                                               Control Register
 0000                  84  ch0f equ     7
 0000                  85  ch0ie        equ     6       ;
 0000                  86  ms0b equ     5       ;
 0000                  87  ms0a equ     4       ;
 0000                  88  els0b        equ     3       ;
 0000                  89  els0a        equ     2       ;
 0000                  90  tov0 equ     1       ;
 0000                  91  ch0max       equ     0       ;
                       92  
 0000                  93  TCH0H        EQU     $0026   ; Timer Channel 0 
                                                                  Register High
 0000                  94  TCH0L        EQU     $0027   ; Timer Channel 0 
                                                                   Register Low
                       95  
 0000                  96  TSC1 EQU     $0028   ; Timer Channel 1 Status & 
                                                               Control Register
 0000                  97  ch1f equ     7
 0000                  98  ch1ie        equ     6       ;
 0000                  99  ms1b equ     5       ;
 0000                 100  ms1a equ     4       ;
 0000                 101  els1b        equ     3       ;
 0000                 102  els1a        equ     2       ;
 0000                 103  tov1 equ     1       ;
 0000                 104  ch1max       equ     0       ;
                      105  
 0000                 106  TCH1H        EQU     $0029   ; Timer Channel 1 
                                                                  Register High
 0000                 107  TCH1L        EQU     $002A   ; Timer Channel 1 
                                                                   Register Low
                      108  
                      109  ;***************************************************
                                                    ***************************
                      110  ;---------------REGISTROS DEL OSCILADOR-------------
                                                    ---------------------------
 0000                 111  OSCSC        EQU     $0036   ;Oscillator Status and 
                                                               Control Register
 0000                 112  ecgst        equ     0       ;Read Only!!!!
 0000                 113  ecgon        equ     1       ;
 0000                 114  ecfs0        equ     2       ;
 0000                 115  ecfs1        equ     3       ;


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 4



 0000                 116  icfs0        equ     4       ;
 0000                 117  icfs1        equ     5       ;
 0000                 118  oscopt0      equ     6       ;
 0000                 119  oscopt1      equ     7       ;
                      120  
 0000                 121  OSCTRIM      EQU     $0038   ;Oscillator Trim 
                                                                       Register
                      122  
 0000                 123  OSCSTAT EQU  $0036   ;Oscillator Status and Control 
                                                         (No Vers A Solo QY/QT)
                      124  
                      125  ;***************************************************
                                                    ***************************
                      126  ;---------------REGISTROS DEL ADC-------------------
                                                    ---------------------------
 0000                 127  ADSCR        EQU     $003C   ; ADC Status & Control 
                                                                       Register
 0000                 128  coco equ     7       ;
 0000                 129  aien equ     6       ;
 0000                 130  adco equ     5       ;
                      131  
 0000                 132  ADRH EQU     $003D   ; ADC10 Data Register High
 0000                 133  ADRL EQU     $003E   ; ADC10 Data Register Low
 0000                 134  ADICLK       EQU     $003F   ; ADC10 Clock Control 
                                                                       Register
                      135  
                      136  ;***************************************************
                                                    ***************************
                      137  ;---------------REGISTROS DEL MODULO SIM------------
                                                    ---------------------------
 0000                 138  BSR  EQU     $FE00   ; Break Status Register
 0000                 139  sbsw equ     1       ; break wait bit
                      140  
 0000                 141  SRSR EQU     $FE01   ; SIM Reset Status Register
 0000                 142  por  equ     7       ;
 0000                 143  pin  equ     6       ;
 0000                 144  cop  equ     5       ;
 0000                 145  ilop equ     4       ;
 0000                 146  ilad equ     3       ;
 0000                 147  modrst       equ     2       ;
 0000                 148  lvi  equ     1       ;
                      149  
 0000                 150  BRKAR        EQU     $FE02   ; Break Auxiliary 
                                                                       Register
 0000                 151  bdcop        equ     0
                      152  
 0000                 153  BFCR EQU     $FE03   ; Break Flag Control Register
 0000                 154  bcfe equ     7       ;
                      155  
 0000                 156  INT1 EQU     $FE04   ; Interrupt Status Register 1
                      157  
 0000                 158  INT2 EQU     $FE05   ; Interrupt Status Register 2
                      159  
 0000                 160  INT3 EQU     $FE06   ; Interrupt Status Register 3
                      161  
                      162  ;***************************************************
                                                    ***************************
                      163  ;---------------REGISTROS DE LA MEMORIA FLASH-------


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 5



                                                    ---------------------------
 0000                 164  FLCR EQU     $FE08   ; FLASH Control Register
                      165  
 0000                 166  FLBPR        EQU     $FFBE   ; FLASH Block Protect
                      167  
                      168  ;***************************************************
                                                    ***************************
                      169  ;---------------REGISTROS DEL MODULO BREAK----------
                                                     --------------------------
 0000                 170  BRKH EQU     $FE09   ; Break address Hig Register
                      171  
 0000                 172  BRKL EQU     $FE0A   ; Break Address Low Register
                      173  
 0000                 174  BRKSCR       EQU     $FE0B   ; Break Status & 
                                                               Control Register
                      175  
                      176  ;***************************************************
                                                    ***************************
                      177  ;---------------REGISTROS DEL MODULO LVI------------
                                                    ---------------------------
 0000                 178  LVISR        EQU     $FE0C   ; LVI Status Register
                      179  
                      180  ;***************************************************
                                                    ***************************
                      181  ;---------------REGISTROS DEL MODULO OSCILLATOR-----
                                                    ---------------------------
 0000                 182  IOSCTRM EQU  $FFC0   ; Internal Oscillator Trim 
                                                  (Factory Prog Value Optional)
                      183  
                      184  ;***************************************************
                                                    ***************************
                      185  ;---------------REGISTROS DEL MODULO COP WATCHDOG---
                                                    ---------------------------
 0000                 186  COPCTL       EQU     $FFFF   ; COP Control Register
                      187  
                      188  ;***************************************************
                                                    ***************************
                      189  ;***************************************************
                                                    ***************************
                      190  ; RUTINAS DE MANEJO DE LA MEMORIA FLASH SITUADAS EN 
                                                    LA ROM MONITOR (HC908QTQYx)
                      191  ;***************************************************
                                                    ***************************
                      192  
 0000                 193  PRGRNGE              EQU     $2809   ;Programa un 
                                                  rango de direcciones de Flash
 0000                 194  ERARNGE              EQU     $2806   ;Borra una 
                                                        pagina de Memoria Flash
 0000                 195  GETBYTE              EQU     $2800   ;Recibe un 
                                              Byte en Modo Monitordesde el Port
 0000                 196  RDVRRNG              EQU     $2803   ;Usa un Rango 
                                               de la Flash y lo envia x el Port
 0000                 197  DELNUS               EQU     $280C   ;Rutina de 
                                                  Demora (usa parametros[A][X])
                      198  
                      199  ;***************************************************
                                                    ***************************
                      200  ;       SyHDe - Soft y Hard Desarrollos, 2000  - 


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 6



                                                          Derechos Reservados -
                      201  ; Ud.uede usar este archivo gratuitamente mientras 
                                                     incluya este pie de pagina
                      202  ;***************************************************
                                                    ***************************
                      203  
                      204  
                      205  ;***************************************************
                                                    ***************************
                      206  ;    DEFINICION DE LAS VARIABLES DE RAM DEL EQUIPO
                      207  ;***************************************************
                                                    ***************************
 0080                 208       org     RAM_INI
                      209  
 0080                 210  contador     rmb     $01             ;Estado del 
                                                                 Cont de salida
 0081                 211  contador_2   rmb     $01             ;Estado del 
                                                                Cont de Entrada
                      212  
                      213  ;***************************************************
                                                    ***************************
                      214  ;            INICIO del PROGRAMA PRINCIPAL
                      215  ;***************************************************
                                                    ***************************
                      216  ;    Arranca AQUI cada vez que se APAGA el Equipo 
                                                               (Power On Reset)
                      217  ;---------------------------------------------------
                                                    ---------------------------
 F800                 218       org     FLASH_INI
                      219  start:
 F800 [01] 4F         220       clra                            ;Inicializo 
                                                          los Registros del CPU
 F801 [01] 5F         221       clrx                            ;
 F802 [01] 8C         222       clrh                            ;
 F803 [02] 9B         223       sei                             ;Desabilito 
                                                                 Interrupciones
                      224  ;---------------------------------------;
 F804 [05] CDF88B     225       jsr     prog_modulos            ;> Programo 
                                                              TODOS los Modulos
                      226  ;---------------------------------------;
 F807 [02] 9A         227       cli                             ; habilito 
                                                                 interrupciones
                      228  ;***************************************************
                                                    ***************************
                      229  ;                          configuro el KBI
                      230  ;***************************************************
                                                    ***************************
 F808 [04] 6E011B     231          MOV #%00000001,KBIER            ;configuro 
                                                    que solo el pin 13 KBI0, es
                      232                                          ;el pin de 
                                                                entrada del kbi
 F80B [04] 141A       233          bset ACKK,KBSCR                 ;desabilito 
                                                 interrupciones pendientes ACKK
 F80D [04] 111A       234          bclr MODEK,KBSCR                ;solo int. 
                                                   por flanco descendente MODEK
 F80F [04] 131A       235          bclr IMASKK,KBSCR               ;hab. int. 
                                                         no enmascaradas IMASKK
                      236  ;***************************************************


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 7



                                                    ***************************
                      237  ;                          configuro el timer
                      238  ;***************************************************
                                                    ***************************
 F811 [04] 6E2620     239          mov #%00100110,TSC              ;desabilito 
                                                         el timer y programo el
                      240           ;bit 76543210                  ;prescaler
                      241                                          ;bit 
                                                     0,1,2--->prescaler en este
                      242                                          ;caso 
                                                             110(divido por 64)
                      243                                          ;bit4---> 
                                                           trts=0 deshabilitado
                      244                                          ;bit5---> 
                                                          tstop=1 deshabilitado
                      245                                          ;bit6---> 
                                                            toie=0 desabilitado
                      246                                          ;bit7---> 
                                                           tof=0 desabiltado xq
                      247                                          ;el timer 
                             no comenzo a contar.                              
                                                                               
                      248  
                      249  ;************************************
                      250  ;*            rango*frec. oscilador  * 1[seg]*(12,8*
                                                                      10^6)[Hz]
                      251  ;*TMOD H,L= ------------------------ *--------------
                                                       --------- = 50000 =$C350
                      252  ;*                4*prescaler        *          4* 
                                                                             64
                      253  ;************************************
                      254  
                      255  
 F814 [04] 6EC323     256          mov #$C3,TMODH                  ;part alta 
                                                                       del tmod
 F817 [04] 6E5024     257          mov #$50,TMODL                  ;part baja 
                                                                       del tmod
 F81A [04] 6E4620     258          mov #%01000110,TSC              ;habilito 
                                                         el timer y programo el
                      259           ;bit 76543210                  ;prescaler
                      260                                          ;bit 
                                                     0,1,2--->prescaler en este
                      261                                          ;caso 
                                                             110(divido por 64)
                      262                                          ;bit4---> 
                                                              trts=0 habilitado
                      263                                          ;bit5---> 
                                                             tstop=1 habilitado
                      264                                          ;bit6---> 
                                                              toie=0 habilitado
                      265                                          ;bit7---> 
                                                    tof=0 hasta que termine el 
                      266                                          ;conteo 
                                                               cambia de estado
                      267                                          
                      268  
                      269  ;***************************************************
                                                    ***************************


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 8



                      270  ;    DEFINICION DE LOS PINES DE ENTRADA/SALIDA DEL 
                                                                         EQUIPO
                      271  ;***************************************************
                                                    ***************************
                      272  ;---------------------- Puerto B--------------------
                                                    ---------------------------
 F81D [04] 6E0001     273          mov     #%00000000,PORTB         ;Programo 
                                                         el PTB y luego el DDRA
 F820 [04] 6EFF05     274          mov     #%11111111,DDRB               ;DDRA 
                                                                  todos salidas
 F823 [04] 6E0001     275          mov     #%00000000,PORTB         ;Escribo 
                                                            Valores por default
                      276  
 F826                 277  led_1                equ     0               
                                                       ;Salida Control de Led 1
 F826                 278  led_2                equ     1               
                                                       ;Salida Control de Led 2
 F826                 279  led_3                equ     2               
                                                       ;Salida Control de Led 3
 F826                 280  led_4                equ     3               
                                                       ;Salida Control de Led 4
 F826                 281  led_5                equ     4               
                                                       ;Salida Control de Led 5
 F826                 282  led_6                equ     5               
                                                       ;Salida Control de Led 6
 F826                 283  led_7                equ     6               
                                                       ;Salida Control de Led 7
 F826                 284  led_8                equ     7               
                                                       ;Salida Control de Led 8
                      285  
                      286  ;***************************************************
                                                   ****************************
                      287  ;                          puerto A
                      288  ;***************************************************
                                                   ****************************
 F826 [04] 6EE700     289           mov     #%11100111,PORTA    ;Programo el 
                                                            PTA y luego el DDRA
 F829 [04] 6EFE04     290           mov     #%11111110,DDRA     ;programo al 
                                                           ddra bit 1-7 salidas
                      291                                          ;y el bit o 
                                                        como entrada en nuestro
                      292                                          ;para 
                                                               usarlo en el KBI
 F82C [04] 6EE700     293           mov     #%11100111,PORTA    ;Escribo 
                                                            Valores por default
                      294          
 F82F                 295  pul_kbi         equ     0               ;nombro al 
                                                     bit 0 del ptA como pul_kbi
                      296  
                      297  ;***************************************************
                                                    ***************************
                      298  ;                    PROGRAMA PRINCIPAL
                      299  ;***************************************************
                                                    ***************************
                      300  
                      301  inicio:
 F82F [04] 1001       302       bset    led_1,PORTB
 F831 [05] CDF877     303       jsr     demora_rapida


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 9



                      304  
                      305  
 F834 [04] 1101       306       bclr    led_1,PORTB
 F836 [05] CDF877     307       jsr     demora_rapida
                      308  
                      309  
 F839 [03] 20F4       310       bra     inicio          ;
                      311  
                      312  ;---------------------------------------;-----------
                                                    ---------------------------
                      313  ;***************************************************
                                                    ***************************
                      314  ; DEMORA_QY - Demora de 81,761 mseg segun el calculo
                      315  ; Fclock=12.8 MHz -> Fbus=3.2 MHz -> Ciclo T=312,50 
                                                                           nseg
                      316  ;***************************************************
                                                    ***************************
                      317  demora_teclado:
 F83B [02] AE0E       318       ldx     #$0E                    ;[2]\
                      319  dem_2:
 F83D [02] A60E       320       lda     #$0E                    ;[2] |
                      321  dem_1:
 F83F [01] 4A         322       deca
 F840 [02] A100       323          cmp          #00                     ;[1] |
 F842 [03] 26FB       324       bne     dem_1                   ;[3] |  
 F844 [01] 5A         325       decx
 F845 [02] A100       326          cmp  #00                     ;[1] |  
 F847 [03] 26F4       327       bne     dem_2                   ;[3]/
 F849 [04] 81         328       rts                             ;
                      329          
                      330  
                      331  
                      332  
                      333  ;---------------------------------------;-----------
                                                    ---------------------------
                      334  ;***************************************************
                                                    ***************************
                      335  ; DEMORA_QY - Demora de 81,761 mseg segun el calculo
                      336  ; Fclock=12.8 MHz -> Fbus=3.2 MHz -> Ciclo T=312,50 
                                                                           nseg
                      337  ;***************************************************
                                                    ***************************
                      338  demora_qy:
 F84A [02] AEFF       339       ldx     #$ff                    ;[2]\
                      340  dem_2_:
 F84C [02] A6FF       341       lda     #$ff                    ;[2] |
                      342  dem_1_:
 F84E [01] 4A         343       deca
 F84F [02] A100       344          cmp          #00                     ;[1] 
                                               |(((4x255)+4+2)x255)+2+4=261636d
 F851 [03] 26FB       345       bne     dem_1_                  ;[3] |  261636 
                                                                  x 312,5nseg =
 F853 [01] 5A         346       decx
 F854 [02] A100       347          cmp  #00                     ;[1] |  Total= 
                                                                    81,761 mseg
 F856 [03] 26F4       348       bne     dem_2_                  ;[3]/
 F858 [04] 81         349       rts                             ;
                      350  


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 10



                      351  ;***************************************************
                                                    ***************************
                      352  ; DEMORA_1000MS - demora de 1 seg aproximadamente 
                                                               para usos varios
                      353  ; DEMORA_500MS - demora de 500 mseg aproximadamente 
                                                               para usos varios
                      354  ; DEMORA_320MS - demora de 320 mseg aproximadamente 
                                                               para usos varios
                      355  ; DEMORA_240MS - demora de 240 mseg aproximadamente 
                                                               para usos varios
                      356  ;***************************************************
                                                    ***************************
                      357  demora_1000ms:
 F859 [05] CDF84A     358       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F85C [05] CDF84A     359       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F85F [05] CDF84A     360       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F862 [05] CDF84A     361       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F865 [05] CDF84A     362       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F868 [05] CDF84A     363       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
                      364  demora_500ms:
 F86B [05] CDF84A     365       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F86E [05] CDF84A     366       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
                      367  demora_320ms:
 F871 [05] CDF84A     368       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
                      369  demora_240ms:
 F874 [05] CDF84A     370       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
                      371  demora_rapida:
 F877 [05] CDF84A     372       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F87A [05] CDF84A     373       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F87D [04] 81         374       rts
                      375  
                      376  
                      377  ;***************************************************
                                                    ***************************
                      378  ; CLR_RAM - Borro toda la RAM desde donde apunta HX 
                                                                 hasta el final
                      379  ;***************************************************
                                                    ***************************
                      380  clr_all_ram:
 F87E [03] 450080     381       ldhx    #RAM_INI                ;\ Inicializo 
                                                              Totalmente la RAM
                      382  clr_a_ram_0:
 F881 [03] 6F00       383          clr     0,x
 F883 [02] AF01       384          aix     #$01
 F885 [03] 6500B2     385          cphx    #{RAM_INI + 50}              ;Borro 
                                                        50 Bytes de Memoria RAM


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 11



 F888 [03] 26F7       386          bne     clr_a_ram_0          ;menos los 
                                                      ultimos bytes porque sino
 F88A [04] 81         387       rts                             ;no puedo 
                                                               volver de la JSR
                      388  
                      389  
                      390  
                      391  ;***************************************************
                                                    ***************************
                      392  ;***************************************************
                                                    ***************************
                      393  ;                    ARCHIVOS INCLUIDOS
                      394  ;***************************************************
                                                    ***************************
                      395  ;***************************************************
                                                    ***************************
 F88B                 396  $Include     'prog_modul_qtqyA.inc'  ;Programacion 
                                                        de los Modulos de QT/QY
                      397  ****************************************************
                                                    ***************************
                      398  *                    PROG_MODUL_QTQYA - ARCHIVO 
                                                                        INCLUDE
                      399  * Contiene la Programacion de los Modulos del 
                                                           MC68HC908QTxxA/QYxxA
                      400  ****************************************************
                                                    ***************************
                      401  prog_modulos:
                      402  ;-------------- Programo el CONFIG -----------------
                                                    ---------------------------
                      403  
 F88B [04] 6E801E     404       mov     #%10000000,CONFIG2      ;Configuracion 
                                                                   del registro
                      405  ;               \\\\\\\\_____________;RSTEN= 0 
                                                        Funcion inactiva en pin
                      406  ;                \\\\\\\_____________;OSCENINSTOP= 
                                                      0 Oscilador desab en STOP
                      407  ;                 \\\\\\_____________;none
                      408  ;                  \\\\\_____________;none
                      409  ;                   \\\\_____________;none
                      410  ;                    \\\_____________;none
                      411  ;                     \\_____________;IRQEN= 0 IRQ 
                                                                   desabilitada
                      412  ;                      \_____________;IRQPUD= 1 
                                                           Pull Up desconectada
                      413  
                      414  
 F88E [04] 6E0D1F     415          mov  #%00001101,CONFIG1      ;Configuracion 
                                                                   del registro
                      416  ;                  \\\\\\\\_____________;COPD= 1 
                                                               COP desabilitado
                      417  ;                   \\\\\\\_____________;STOP= 0 
                                                  instruccion STOP desabilitada
                      418  ;                    \\\\\\_____________;SSREC= 1 
                                                   Recup de modo STOP 32 ciclos
                      419  ;                     \\\\\_____________;LVITRIP= 1 
                                                              LVI operate en 5V
                      420  ;                      \\\\_____________;LVIPWRD= 0 
                                                                 LVI habilitado


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 12



                      421  ;                       \\\_____________;LVIRSTD= 0 
                                                     Reset desde LVI habilitado
                      422  ;                        \\_____________;LVISTOP= 0 
                                                       LVI desabilitado en STOP
                      423  ;                         \_____________;COPRS= 0 
                                                           COP reset long cycle
                      424  
 F891 [01] 9D         425       nop                             ; aseguran la 
                                                                  configuracion
 F892 [01] 9D         426       nop                             ;
 F893 [01] 9D         427       nop                             ;
                      428  
                      429  ;-------------- Programacion del OSCILADOR QTA/QYA--
                                                    ---------------------------
                      430  ; Fclock=12.8 MHz -> Fbus=3.2 MHz -> Ciclo T=312,50 
                                                                           nseg
                      431  ;---------------------------------------------------
                                                    ---------------------------
                      432  
                      433  
                      434  ;    mov     #$20,oscsc              ; OSCILLATOR 
                                                      STATUS & CONTROL REGISTER
                      435  ;               \\\\\\\\_____________;ECGST= Read 
                                                                           Only
                      436  ;                \\\\\\\_____________;ECGON= 0 
                                                 Oscilador Externo desabilitado
                      437  ;                 \\\\\\_____________;ECFS0= 0 \ 
                                                      00= Xtal Externo 8-32 MHz
                      438  ;                  \\\\\_____________;ECFS1= 0 /
                      439  ;                   \\\\_____________;ICFS0= 0 \ 
                                                               10= Osc 12.8 MHz
                      440  ;                    \\\_____________;ICSF1= 1 /
                      441  ;                     \\_____________;OSCOPT0= 0 \ 
                                                          00= Oscilador Interno
                      442  ;                      \_____________;OSCOPT1= 0 /
                      443  
 F894 [04] 6E8138     444       mov     #$81,OSCTRIM            ;Ajuste Fino 
                                                                  del Oscilador
                      445  
                      446  ;-------------- Programacion del OSCILADOR No 
                                              Version A -----------------------
                      447  ;    mov     #%00000000,OSCSTAT      ; OSCILLATOR 
                                                                STATUS REGISTER
                      448  ;
                      449  ;---------------------------------------------------
                                                    ---------------------------
 F897 [05] CDF84A     450       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F89A [05] CDF84A     451       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F89D [05] CDF84A     452       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F8A0 [05] CDF84A     453       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F8A3 [05] CDF84A     454       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg
 F8A6 [05] CDF84A     455       jsr     demora_qy               ;Demora de 
                                                                    81,761 mseg


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 13



                      456  
                      457  
                      458  
 F8A9 [04] 81         459       rts
                      460  
                      461  
                      462  ;***************************************************
                                                    ***************************
                      463  ;***************************************************
                                                    ***************************
                      464  ;                    RUTINAS DE INTERUPCION
                      465  ;***************************************************
                                                    ***************************
                      466  ;***************************************************
                                                    ***************************
                      467  
                      468  ;***************************************************
                                                    ***************************
                      469  ; ADC_ISR - Rutina de Interrupcion del ADC
                      470  ;***************************************************
                                                    ***************************
                      471  adc_isr:
 F8AA [07] 80         472       rti                             ;
                      473  
                      474  ;***************************************************
                                                    ***************************
                      475  ; KEYB_ISR - Rutina de Interrupcion del KBI
                      476  ;***************************************************
                                                    ***************************
                      477  keyb_isr:
                      478  TECLADO:
 F8AB [05] CDF83B     479                  jsr     demora_teclado          
                                             ;salto una pequea demora por soft
                      480                                                  ;ya 
                                       que el micro trabaja a altas velocidades
                      481                                                  ;la 
                                          pulsacion del boton es como de 10mseg
                      482                                                  
                                                  ;para ello esa pequea demora
 F8AE [05] 010003     483                  brclr   pul_kbi,PTA,PRENDER     
                                             ;pregunto si esta en 0 el pulsador
                      484                                                  ;si 
                                                      esta en 0 salta a prender
 F8B1 [03] CCF8CB     485                  jmp     FIN                     ;si 
                                                       no esta en 0 salte a fin
                      486  
                      487  PRENDER:
 F8B4 [05] CDF8BA     488                  jsr     TRABAJO                 
                                                  ;salte a la subrutina trabajo
 F8B7 [03] CCF8CB     489                  jmp     FIN                     
                                  ;salte a fin cuando vuelve del rts de trabajo
                      490  
                      491  TRABAJO:
 F8BA [04] 1401       492                  bset    led_3,ptb               
                                                            ;prendo led del ptb
 F8BC [05] CDF84A     493                  jsr     demora_qy               
                                   ;salto a la demora para el encendido del led
 F8BF [05] CDF84A     494                  jsr     demora_qy               


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 14



                                   ;salto a la demora para el encendido del led
 F8C2 [04] 1501       495                  bclr    led_3,ptb               
                                                          ;apago el led del ptb
 F8C4 [05] CDF84A     496                  jsr     demora_qy               
                                     ;salto a la demora para el apagado del led
 F8C7 [05] CDF84A     497                  jsr     demora_qy               
                                     ;salto a la demora para el apagado del led
 F8CA [04] 81         498                  rts                             
                                     ;como es una subrutina que mediante un jsr
                      499                                                  
                                     ;(salto a subrutina) se realiza el trabajo
                      500                                                  ;y 
                               vuelve a la ultima posicion donde apuntaba el pc
                      501                                                  
                                         ;mediante un rts (retorn de subrutina)
                      502  
                      503  FIN:
 F8CB [04] 141A       504                  bset    ACKK,KBSCR              
                                               ;borro interrupciones pendientes
 F8CD [04] 131A       505                  bclr    IMASKK,KBSCR            ; 
                                                      hab. int. no enmascaradas
                      506           
 F8CF [07] 80         507       rti                                     
                                                       ;retorno de interrupcion
                      508  
                      509  
                      510  ;***************************************************
                                                    ***************************
                      511  ; TIM1_OV_ISR - Rutina de Interrupcion por Overflow 
                                                                    del Timer 1
                      512  ;***************************************************
                                                    ***************************
                      513  tim1_ov_isr:
 F8D0 [05] 0D0104     514       brclr   led_7,PTB,encender               
                                               ;pregunta si el led esta apagado
                      515                                                   ; 
                                                      si no esta apagado sigue,
                      516                                                   ; 
                                             y si esta apagado salte a encender
 F8D3 [04] 1D01       517       bclr    led_7,PTB                        
                                                                     ;apaga LED
 F8D5 [03] 2002       518       bra     apagado                          
                                                               ;salte a apagado
                      519  encender:
 F8D7 [04] 1C01       520       bset    led_7,PTB                        
                                                                  ;Enciende LED
                      521  apagado:
 F8D9 [04] 1F20       522       bclr    tof,TSC                          ;Pone 
                               a 0 el bit "tof" del registro tsc": esto permite
                      523                                                   
                             ;que al salir de esta subrrutina (del vector de 
                                                                       interrup
                      524                                                   
                             ;"TIM_OV_ISR") se borre la mscara de interrup I 
                                                                        de modo
                      525                                                   
                             ;que cuando el mdulo TIM genere el prximo 
                                                                      pedido de


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 15



                      526                                                   
                                                ;interrup, el micro lo atienda.
                      527                                                   
                                                 ;retorna al programa principal
                      528                 
 F8DB [07] 80         529       rti
                      530  
                      531  
                      532  ;***************************************************
                                                    ***************************
                      533  ; TIM1_1_ISR - Rutina de Interrupcion del Canal 1 
                                                                    del Timer 1
                      534  ;***************************************************
                                                    ***************************
                      535  tim1_1_isr:
 F8DC [07] 80         536       rti                             ;
                      537  
                      538  
                      539  ;***************************************************
                                                    ***************************
                      540  ; TIM1_0_ISR - Rutina de Interrupcion del Canal 0 
                                                                    del Timer 1
                      541  ;***************************************************
                                                    ***************************
                      542  tim1_0_isr:
 F8DD [07] 80         543       rti                             ;
                      544  
                      545  ;***************************************************
                                                    ***************************
                      546  ; IRQ_ISR - Rutina de Interrupcion Externa
                      547  ;***************************************************
                                                    ***************************
                      548  irq_isr:
 F8DE [01] 9D         549       nop                             ;
 F8DF [07] 80         550       rti                             ;
                      551  
                      552  ;***************************************************
                                                    ***************************
                      553  ; SWI_ISR - Rutina de Interrupcion por Software
                      554  ;***************************************************
                                                    ***************************
                      555  swi_isr:
 F8E0 [01] 9D         556          nop                          ;
 F8E1 [07] 80         557          rti                          ;
                      558  
                      559  ;***************************************************
                                                    ***************************
                      560  ; DUMMY_ISR - Dummy Interrupt Service Routine
                      561  ; Rutina de servicio de Interupcion Fantasma, se 
                                                  pone por razones de seguridad
                      562  ;***************************************************
                                                    ***************************
                      563  dummy_isr:
 F8E2 [01] 9D         564          nop                          ;
 F8E3 [07] 80         565          rti                          ; vuelve sin 
                                                                     hacer nada
                      566  
                      567  ;***************************************************


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 16



                                                    ***************************
                      568  ; FLASH BLOCK PROTECT - Grabacion del Mismo
                      569  ;***************************************************
                                                    ***************************
                      570  ;    Org     FLBPR
                      571  ;    fcb     $ff                     ;Toda!!! la 
                                                      memoria esta desprotegida
                      572  ;
                      573  ;***************************************************
                                                    ***************************
                      574  ; VECTORES - Definicion de Vectores del Sistema
                      575  ;***************************************************
                                                    ***************************
 FFDE                 576       org     VECTORES
 FFDE      F8AA       577       fdb     adc_isr         ; ADC Vector
 FFE0      F8AB       578       fdb     keyb_isr        ; KEYBOARD Vector
                      579  
 FFF2                 580       org     $FFF2
 FFF2      F8D0       581       fdb     tim1_ov_isr     ; TIM1 Overflow Vector
 FFF4      F8DC       582       fdb     tim1_1_isr      ; TIM1 Channel 1 Vector
 FFF6      F8DD       583       fdb     tim1_0_isr      ; TIM1 Channel 0 Vector
                      584  
 FFFA                 585       org     $FFFA
 FFFA      F8DE       586       fdb     irq_isr         ; IRQ1  Vector
 FFFC      F8E0       587       fdb     swi_isr         ; SWI Vector
 FFFE      F800       588       fdb     Start           ; Reset
                      589  
                      590  end
                      591   

 Symbol Table 

ACK              0002
ACKK             0002
ADCO             0005
ADC_ISR          F8AA
ADICLK           003F
ADRH             003D
ADRL             003E
ADSCR            003C
AIEN             0006
APAGADO          F8D9
BCFE             0007
BDCOP            0000
BFCR             FE03
BRKAR            FE02
BRKH             FE09
BRKL             FE0A
BRKSCR           FE0B
BSR              FE00
CH0F             0007
CH0IE            0006
CH0MAX           0000
CH1F             0007
CH1IE            0006
CH1MAX           0000
CLR_ALL_RAM      F87E
CLR_A_RAM_0      F881


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 17



COCO             0007
CONFIG1          001F
CONFIG2          001E
CONTADOR         0080
CONTADOR_2       0081
COP              0005
COPCTL           FFFF
DDRA             0004
DDRB             0005
DELNUS           280C
DEMORA_1000MS    F859
DEMORA_240MS     F874
DEMORA_320MS     F871
DEMORA_500MS     F86B
DEMORA_QY        F84A
DEMORA_RAPIDA    F877
DEMORA_TECLADO   F83B
DEM_1            F83F
DEM_1_           F84E
DEM_2            F83D
DEM_2_           F84C
DUMMY_ISR        F8E2
ECFS0            0002
ECFS1            0003
ECGON            0001
ECGST            0000
ELS0A            0002
ELS0B            0003
ELS1A            0002
ELS1B            0003
ENCENDER         F8D7
END              0000
ERARNGE          2806
FIN              F8CB
FLASH_END        FDFF
FLASH_INI        F800
FLBPR            FFBE
FLCR             FE08
GETBYTE          2800
ICFS0            0004
ICFS1            0005
ILAD             0003
ILOP             0004
IMASK            0001
IMASKK           0001
INICIO           F82F
INT1             FE04
INT2             FE05
INT3             FE06
INTSCR           001D
IOSCTRM          FFC0
IRQF             0003
IRQ_ISR          F8DE
KBIER            001B
KBSCR            001A
KEYB_ISR         F8AB
KEYF             0003
LED_1            0000


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 18



LED_2            0001
LED_3            0002
LED_4            0003
LED_5            0004
LED_6            0005
LED_7            0006
LED_8            0007
LVI              0001
LVISR            FE0C
MODE             0000
MODEK            0000
MODRST           0002
MS0A             0004
MS0B             0005
MS1A             0004
MS1B             0005
OSCOPT0          0006
OSCOPT1          0007
OSCSC            0036
OSCSTAT          0036
OSCTRIM          0038
PIN              0006
POR              0007
PORTA            0000
PORTB            0001
PRENDER          F8B4
PRGRNGE          2809
PROG_MODULOS     F88B
PTA              0000
PTAPUE           000B
PTB              0001
PTBPUE           000C
PUL_KBI          0000
RAM_FIN          0100
RAM_INI          0080
RDVRRNG          2803
SBSW             0001
SRSR             FE01
START            F800
SWI_ISR          F8E0
TCH0H            0026
TCH0L            0027
TCH1H            0029
TCH1L            002A
TCNTH            0021
TCNTL            0022
TECLADO          F8AB
TIM1_0_ISR       F8DD
TIM1_1_ISR       F8DC
TIM1_OV_ISR      F8D0
TMODH            0023
TMODL            0024
TOF              0007
TOIE             0006
TOV0             0001
TOV1             0001
TRABAJO          F8BA
TRST             0004


kni_qy4A_simple.asm    Assembled with CASM08Z  27/11/2012  01:06:53 p.m.  PAGE 19



TSC              0020
TSC0             0025
TSC1             0028
TSTOP            0005
VECTORES         FFDE
